const GEMINI_TEXT_API_URL=`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=${GEMINI_API_KEY}`,GEMINI_IMAGE_API_URL=`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-preview-image-generation:generateContent?key=${GEMINI_API_KEY}`;document.addEventListener("DOMContentLoaded",(()=>{let e=null;const t=document.querySelectorAll(".step"),n=document.getElementById("theme-input"),o=document.getElementById("generate-script-btn"),a=document.getElementById("script-output"),r=document.getElementById("copy-script-btn"),i=document.getElementById("go-to-audio-step-btn"),s=document.getElementById("audio-input"),d=document.getElementById("process-video-btn"),c=document.getElementById("generation-status"),l=document.getElementById("generation-title"),m=document.getElementById("final-video-player"),p=document.querySelectorAll(".progress-step"),u=e=>{p.forEach((t=>{parseInt(t.dataset.step,10)<=e?t.classList.add("active"):t.classList.remove("active")}))},g=e=>{t.forEach((e=>e.classList.remove("visible"))),document.getElementById(e).classList.add("visible"),"step-theme-input"===e?u(1):"step-script-review"===e?u(2):"step-audio-selection"===e?u(3):"step-generating-video"===e?u(4):"final-video-container"===e&&p.forEach((e=>e.classList.add("active")))},h=async(e,t)=>{const n=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!n.ok){const e=await n.json();throw new Error(`Erro na API (${n.status}): ${e.error?.message}`)}return n.json()};function E(e){return`${Math.floor(e/3600).toString().padStart(2,"0")}:${Math.floor(e%3600/60).toString().padStart(2,"0")}:${Math.floor(e%60).toString().padStart(2,"0")},${Math.round(1e3*(e-Math.floor(e))).toString().padStart(3,"0")}`}o.addEventListener("click",(async()=>{const e=n.value.trim();if(!e)return alert("Por favor, insira um tema.");o.disabled=!0,o.textContent="Gerando...";try{const t={contents:[{parts:[{text:`Crie um roteiro de narração curto e envolvente para um vídeo vertical sobre o tema: "${e}". O texto deve ser fluido e natural, dividido em 3 parágrafos curtos. Responda apenas com o texto do roteiro.`}]}]},n=await h(GEMINI_TEXT_API_URL,t);a.value=n.candidates[0].content.parts[0].text.trim(),g("step-script-review")}catch(e){alert(e.message)}finally{o.disabled=!1,o.textContent="Gerar Roteiro"}})),r.addEventListener("click",(()=>{a.select(),document.execCommand("copy"),alert("Roteiro copiado!")})),i.addEventListener("click",(()=>g("step-audio-selection"))),s.addEventListener("change",(t=>{t.target.files.length>0&&(e=t.target.files[0],d.disabled=!1)})),d.addEventListener("click",(async()=>{if(!e)return alert("Nenhum arquivo de áudio selecionado.");g("step-generating-video");try{c.textContent="1/4 - Transcrevendo seu áudio...";const t=await async function(e){if(!GROQ_API_KEY)throw new Error("Chave API Groq não configurada.");const t=new FormData;t.append("file",e),t.append("model","whisper-large-v3"),t.append("response_format","verbose_json"),t.append("timestamp_granularities[]","word"),t.append("timestamp_granularities[]","segment");const n=await fetch("https://api.groq.com/openai/v1/audio/transcriptions",{method:"POST",headers:{Authorization:`Bearer ${GROQ_API_KEY}`},body:t});if(!n.ok){const e=await n.json();throw new Error(`Erro na API Groq: ${e.error.message}`)}return n.json()}(e);if(!t?.segments?.length)throw new Error("A transcrição falhou ou não retornou segmentos.");c.textContent="2/4 - Agrupando a narração em cenas...";const n=function(e,t=25){if(!e||0===e.length)return[];const n=[];let o="",a=e[0].start;for(let r=0;r<e.length;r++){const i=e[r],s=o?`${o} ${i.text}`:i.text;s.split(" ").length>t&&o?(n.push({text:o,start:a,end:e[r-1].end}),o=i.text,a=i.start):o=s}o&&n.push({text:o,start:a,end:e[e.length-1].end});return n}(t.segments);c.textContent=`3/4 - Criando ${n.length} imagens...`;const o=await async function(e,t,n){const o=[];for(let a=0;a<e.length;a++){const r=e[a];t.textContent=`3/4 - Criando imagem ${a+1} de ${n}...`;const i={contents:[{parts:[{text:`Para a frase: "${r.text}", crie um prompt de imagem conciso em inglês para um gerador de IA. O prompt deve ser descritivo e cinematográfico. Responda apenas com o prompt.`}]}],generationConfig:{temperature:.7}},s=(await h(GEMINI_TEXT_API_URL,i)).candidates[0].content.parts[0].text.trim(),d={contents:[{parts:[{text:`${s} (9:16 aspect ratio, vertical, cinematic, photorealistic)`}]}],generationConfig:{responseModalities:["TEXT","IMAGE"]}},c=(await h(GEMINI_IMAGE_API_URL,d)).candidates[0].content.parts.find((e=>e.inlineData&&e.inlineData.mimeType.startsWith("image/")));if(!c)throw new Error(`API não retornou uma imagem para o prompt: "${s}"`);const l=c.inlineData.data;o.push(`data:image/png;base64,${l}`)}return o}(n,c,n.length);l.textContent="Renderizando seu vídeo...",c.textContent="Esta etapa final pode levar alguns minutos. Não feche a página.";const a=new CapCutStyleGenerator("pixi-container","generation-status");await a.init();const r=URL.createObjectURL(e);await a.loadAssets(o,r);const i=n.map(((e,t)=>`${t+1}\n${E(e.start)} --\x3e ${E(e.end)}\n${e.text}`)).join("\n\n");a.parseSRT(i),await async function(e,t){try{if(!t||!t.words&&!t.segments)throw new Error("Dados de transcrição inválidos.");const n=new WordSubtitleAnimator;n.init(e),t.words&&t.words.length>0?n.setTimeline(t):t.segments&&n.setTimeline(t.segments),e.subtitleAnimator=n;const o=()=>{let t=e.audioElement||e.audio||document.querySelector("audio")||document.querySelector('[src*=".mp3"], [src*=".wav"], [src*=".ogg"]');t?n.startAnimation(t):setTimeout(o,1e3)};o()}catch(e){console.error("Erro no módulo de legendas:",e)}}(a,t),await a.exportVideo((e=>{e?(m.src=e,g("final-video-container")):(alert("Falha ao gerar o vídeo final."),g("step-audio-selection"))}))}catch(e){console.error("Erro detalhado:",e),alert("Ocorreu um erro no processo: "+e.message),g("step-audio-selection")}}))}));
